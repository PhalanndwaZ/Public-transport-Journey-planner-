<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transit Schedule Admin</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <main class="container results admin-shell">
    <header class="admin-header">
      <div>
        <h1>Transit Schedule Admin</h1>
        <p class="tagline">Manage MyCiTi, Golden Arrow, and Train schedules</p>
      </div>
      <div class="admin-actions">
        <button id="refresh-button" class="pill-button">Refresh</button>
        <button id="reload-button" class="pill-button primary">Reload Schedules</button>
      </div>
    </header>

    <section class="admin-summary" aria-label="Schedule overview">
      <article class="summary-card">
        <span class="summary-label">Schedules</span>
        <span id="summary-count" class="summary-value">0</span>
      </article>
      <article class="summary-card">
        <span class="summary-label">Total size</span>
        <span id="summary-size" class="summary-value">0 KB</span>
      </article>
      <article class="summary-card">
        <span class="summary-label">Last updated</span>
        <span id="summary-updated" class="summary-value">�</span>
      </article>
    </section>

    <div id="status" class="alert hidden" role="status"></div>

    <section class="form-section">
      <div class="table-toolbar">
        <h2>Current schedules</h2>
        <label class="filter">
          <span>Filter by type:</span>
          <select id="type-filter"></select>
        </label>
      </div>
      <div id="schedule-table"></div>
    </section>

    <section class="form-section">
      <div class="table-toolbar">
        <h2>Recently deleted</h2>
      </div>
      <div id="bin-container" class="bin-container"></div>
    </section>

    <section class="form-section">
      <h2>Add a schedule</h2>
      <form id="add-form" class="upload-form">
        <div class="field">
          <label for="add-type">Schedule type</label>
          <select id="add-type" name="type" required></select>
        </div>
        <div class="field hidden" id="add-filename-field">
          <label for="add-filename">Filename (.csv)</label>
          <input type="text" id="add-filename" name="filename" placeholder="example.csv">
        </div>
        <div class="field">
          <label for="add-file">CSV file</label>
          <input type="file" id="add-file" name="file" accept=".csv" required>
        </div>
        <div class="admin-actions">
          <button type="submit" class="pill-button primary">Upload</button>
        </div>
      </form>
    </section>
  </main>

  <input id="replace-file" type="file" accept=".csv" class="hidden" aria-hidden="true">

  <script>
    const API_BASE = 'http://localhost:4567';
    const statusEl = document.getElementById('status');
    const tableContainer = document.getElementById('schedule-table');
    const summaryCount = document.getElementById('summary-count');
    const summarySize = document.getElementById('summary-size');
    const summaryUpdated = document.getElementById('summary-updated');
    const typeFilter = document.getElementById('type-filter');
    const addTypeSelect = document.getElementById('add-type');
    const addFilenameField = document.getElementById('add-filename-field');
    const addFilenameInput = document.getElementById('add-filename');
    const addForm = document.getElementById('add-form');
    const replaceInput = document.getElementById('replace-file');
    const binContainer = document.getElementById('bin-container');

    let scheduleTypes = [];
    let schedules = [];
    let binItems = [];
    let pendingReplacePath = null;

    /** Displays a dismissible status alert with the provided message and style. */
    function showStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `alert ${type}`;
      statusEl.classList.remove('hidden');
    }

    /** Hides the status alert without altering its text. */
    function clearStatus() {
      statusEl.classList.add('hidden');
    }

    /** Formats a byte count into human-readable units. */
    function formatBytes(size) {
      if (!Number.isFinite(size) || size <= 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      const tier = Math.min(units.length - 1, Math.floor(Math.log10(size) / 3));
      const value = size / Math.pow(1000, tier);
      return `${value.toFixed(value >= 10 ? 0 : 1)} ${units[tier]}`;
    }

    /** Chooses the most informative label for a deleted timestamp. */
    function formatDeletedLabel(label, iso) {
      if (typeof label === 'string' && label.trim()) {
        return label;
      }
      if (typeof iso === 'string') {
        const date = new Date(iso);
        if (!Number.isNaN(date.getTime())) {
          return date.toLocaleString();
        }
      }
      return 'Unknown';
    }

    /** Populates the schedule type filter and upload dropdowns. */
    function renderTypes() {
      typeFilter.innerHTML = '<option value="all">All types</option>';
      addTypeSelect.innerHTML = '';
      scheduleTypes.forEach((type, index) => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = type.label;
        typeFilter.appendChild(option.cloneNode(true));
        addTypeSelect.appendChild(option);
        if (index === 0) {
          addTypeSelect.value = type.id;
        }
      });
      typeFilter.value = 'all';
      updateAddFormFields();
    }

    /** Refreshes the summary cards using the currently visible schedules. */
    function updateSummary(items) {
      summaryCount.textContent = items.length;
      const totalSize = items.reduce((sum, item) => sum + Number(item.sizeBytes || 0), 0);
      summarySize.textContent = formatBytes(totalSize);
      const latestTimestamp = items.reduce((latest, item) => {
        const ts = Date.parse(item.lastModified || '');
        return Number.isFinite(ts) && ts > latest ? ts : latest;
      }, 0);
      summaryUpdated.textContent = latestTimestamp ? new Date(latestTimestamp).toLocaleString() : '�';
    }

    /** Returns schedules that match the active type filter. */
    function filteredSchedules() {
      if (typeFilter.value === 'all') return schedules;
      return schedules.filter((item) => item.type === typeFilter.value);
    }

    /** Renders the main schedule table with action buttons. */
    function renderTable(items) {
      if (!items.length) {
        tableContainer.innerHTML = '<p class="text-muted">No schedules found for the selected type.</p>';
        return;
      }

      const rows = items.map((item) => `
        <tr>
          <td>
            <div class="schedule-name">
              <span class="badge">${item.typeLabel}</span>
              <span>${item.name}</span>
            </div>
          </td>
          <td>${formatBytes(Number(item.sizeBytes || 0))}</td>
          <td>${item.lastModified || 'Unknown'}</td>
          <td class="actions">
            <button class="action-button accent" data-action="replace" data-path="${item.path}">Replace</button>
            <button class="action-button danger" data-action="delete" data-path="${item.path}">Delete</button>
          </td>
        </tr>
      `).join('');

      tableContainer.innerHTML = `
        <div class="table-wrapper">
          <table class="data-table schedule-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Size</th>
                <th>Last Modified</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    /** Renders the recently deleted schedules table. */
    function renderBin(items) {
      if (!binContainer) return;
      if (!Array.isArray(items) || items.length === 0) {
        binContainer.innerHTML = '<p class="text-muted">No schedules in the bin.</p>';
        return;
      }

      const rows = items.map((item) => `
        <tr>
          <td>
            <div class="schedule-name">
              <span class="badge">${item.categoryLabel || item.categoryId || 'Unknown'}</span>
              <span>${item.filename || item.path}</span>
            </div>
            <div class="schedule-path">${item.path}</div>
          </td>
          <td>${formatBytes(Number(item.sizeBytes || 0))}</td>
          <td>${formatDeletedLabel(item.deletedAt, item.deletedAtIso)}</td>
          <td class="actions">
            <button class="action-button success" data-restore-id="${item.id}">Restore</button>
          </td>
        </tr>
      `).join('');

      binContainer.innerHTML = `
        <div class="table-wrapper">
          <table class="data-table schedule-table">
            <thead>
              <tr>
                <th>Schedule</th>
                <th>Size</th>
                <th>Deleted</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    /** Fetches schedule metadata from the backend and updates the UI. */
    async function loadSchedules() {
      clearStatus();
      try {
        const response = await fetch(`${API_BASE}/admin/schedules`);
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Failed to load schedules');
        }
        scheduleTypes = Array.isArray(data.types) ? data.types : [];
        schedules = Array.isArray(data.schedules) ? data.schedules : [];
        binItems = Array.isArray(data.bin) ? data.bin.slice(0, 3) : [];
        renderTypes();
        const current = filteredSchedules();
        updateSummary(current);
        renderTable(current);
        renderBin(binItems);
      } catch (error) {
        showStatus(error.message, 'error');
        tableContainer.innerHTML = '<p class="text-muted">Unable to load schedules.</p>';
        if (binContainer) {
          binContainer.innerHTML = '<p class="text-muted">Bin is unavailable.</p>';
        }
      }
    }

    /** Shows or hides filename controls based on the selected type. */
    function updateAddFormFields() {
      const typeId = addTypeSelect.value;
      const type = scheduleTypes.find((t) => t.id === typeId);
      const needsFilename = type ? Boolean(type.requiresFilename) : false;
      if (needsFilename) {
        addFilenameField.classList.remove('hidden');
        addFilenameInput.required = true;
      } else {
        addFilenameField.classList.add('hidden');
        addFilenameInput.required = false;
        addFilenameInput.value = '';
      }
    }

    addTypeSelect.addEventListener('change', updateAddFormFields);

    document.getElementById('add-file').addEventListener('change', () => {
      const file = document.getElementById('add-file').files[0];
      if (!file) return;
      const type = scheduleTypes.find((t) => t.id === addTypeSelect.value);
      if (type && type.requiresFilename && !addFilenameInput.value) {
        addFilenameInput.value = file.name;
      }
    });

    addForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearStatus();

      const typeId = addTypeSelect.value;
      const file = document.getElementById('add-file').files[0];
      if (!typeId) {
        showStatus('Select a schedule type.', 'warning');
        return;
      }
      if (!file) {
        showStatus('Choose a CSV file to upload.', 'warning');
        return;
      }

      const type = scheduleTypes.find((t) => t.id === typeId);
      if (!type) {
        showStatus('Unknown schedule type.', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('type', typeId);
      if (type.requiresFilename) {
        const filename = addFilenameInput.value.trim();
        if (!filename) {
          showStatus('Enter a filename for the new schedule.', 'warning');
          return;
        }
        formData.append('filename', filename);
      }
      formData.append('file', file);

      try {
        const response = await fetch(`${API_BASE}/admin/schedules/add`, {
          method: 'POST',
          body: formData
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Upload failed');
        }
        showStatus(payload.message || 'Schedule added.', 'success');
        addForm.reset();
        updateAddFormFields();
        loadSchedules();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    });

    tableContainer.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const path = button.dataset.path;
      if (!path) return;

      if (button.dataset.action === 'replace') {
        pendingReplacePath = path;
        replaceInput.value = '';
        replaceInput.click();
      } else if (button.dataset.action === 'delete') {
        if (confirm('Delete this schedule? This action cannot be undone.')) {
          deleteSchedule(path);
        }
      }
    });

    if (binContainer) {
      binContainer.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-restore-id]');
        if (!button) return;
        const id = button.dataset.restoreId;
        if (!id) return;
        restoreSchedule(id);
      });
    }

    replaceInput.addEventListener('change', async () => {
      if (!pendingReplacePath || replaceInput.files.length === 0) {
        return;
      }
      const file = replaceInput.files[0];
      const formData = new FormData();
      formData.append('path', pendingReplacePath);
      formData.append('file', file);

      try {
        clearStatus();
        const response = await fetch(`${API_BASE}/admin/schedules/update`, {
          method: 'POST',
          body: formData
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Update failed');
        }
        showStatus(payload.message || 'Schedule updated.', 'success');
        loadSchedules();
      } catch (error) {
        showStatus(error.message, 'error');
      } finally {
        pendingReplacePath = null;
        replaceInput.value = '';
      }
    });

    /** Requests deletion of the given schedule path and reloads data. */
    async function deleteSchedule(path) {
      clearStatus();
      try {
        const params = new URLSearchParams();
        params.append('path', path);
        const response = await fetch(`${API_BASE}/admin/schedules/delete`, {
          method: 'POST',
          body: params
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Delete failed');
        }
        showStatus(payload.message || 'Schedule deleted.', 'success');
        loadSchedules();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    }

    /** Restores a trashed schedule by its identifier. */
    async function restoreSchedule(id) {
      clearStatus();
      try {
        const params = new URLSearchParams();
        params.append('id', id);
        const response = await fetch(`${API_BASE}/admin/schedules/restore`, {
          method: 'POST',
          body: params
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Restore failed');
        }
        showStatus(payload.message || 'Schedule restored.', 'success');
        loadSchedules();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    }

    document.getElementById('refresh-button').addEventListener('click', loadSchedules);

    document.getElementById('reload-button').addEventListener('click', async () => {
      clearStatus();
      try {
        const response = await fetch(`${API_BASE}/admin/schedules/reload`, { method: 'POST' });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Reload failed');
        }
        showStatus(payload.message || 'Transit data reloaded.', 'success');
        loadSchedules();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    });

    typeFilter.addEventListener('change', () => {
      const items = filteredSchedules();
      updateSummary(items);
      renderTable(items);
    });

    loadSchedules();
  </script>
</body>
</html>
