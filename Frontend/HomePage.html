<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Journey Planner - Home</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1>Journey Planner</h1>
    <p class="tagline">Find the fastest combination of buses and trains across Cape Town.</p>
  </header>

  <main class="container">
    <form id="journey-form" novalidate>
      <section class="form-section">
        <h2 class="section-title">Trip Details</h2>
        <div class="field">
          <label for="from">From</label>
          <div class="input-group">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="from" name="from" placeholder="Start typing a pickup location" autocomplete="off" required>
            <input type="hidden" id="from-name">
            <input type="hidden" id="from-lat">
            <input type="hidden" id="from-lng">
          </div>
        </div>

        <div class="field">
          <label for="to">To</label>
          <div class="input-group">
            <i class="fas fa-location-arrow"></i>
            <input type="text" id="to" name="to" placeholder="Choose your destination" autocomplete="off" required>
            <input type="hidden" id="to-name">
            <input type="hidden" id="to-lat">
            <input type="hidden" id="to-lng">
          </div>
        </div>

        <div class="field-grid">
          <div class="field">
            <label for="date">Date</label>
            <div class="input-group">
              <i class="fas fa-calendar-alt"></i>
              <input type="date" id="date" name="date" required>
            </div>
          </div>
          <div class="field">
            <label for="time">Departure Time</label>
            <div class="input-group">
              <i class="fas fa-clock"></i>
              <input type="time" id="time" name="time" required>
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <h2 class="section-title">Transport Preferences <span class="optional">Optional</span></h2>
        <p class="section-help">Fine-tune the journey by filtering the modes you prefer and how far you are willing to walk.</p>

        <div class="mode-toggle">
          <label class="toggle">
            <input type="checkbox" id="pref-bus" checked>
            <span>Bus</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="pref-train" checked>
            <span>Train</span>
          </label>
        </div>

        <div class="field">
          <label for="max-walk">Maximum walking distance per segment (metres)</label>
          <div class="input-group">
            <i class="fas fa-walking"></i>
            <input type="number" id="max-walk" name="maxWalkMeters" min="0" step="50" placeholder="Default 800">
          </div>
          <small class="field-note">Leave blank to keep the default allowance. Set to 0 to disable walking links.</small>
        </div>
      </section>

      <button type="submit"><i class="fas fa-search"></i> Plan journey</button>
    </form>
  </main>

  <footer>
    &copy; 2025 Journey Planner
  </footer>

  <script>
    const capeTownBounds = {
      south: -34.4,
      west: 18.15,
      north: -33.5,
      east: 19.05
    };

    const storedPlaces = {
      from: null,
      to: null
    };

    /** Clears cached coordinates and hidden inputs for the given key. */
    function resetStoredPlace(key) {
      storedPlaces[key] = null;
      document.getElementById(`${key}-lat`).value = "";
      document.getElementById(`${key}-lng`).value = "";
      document.getElementById(`${key}-name`).value = "";
    }

    /** Validates that a lat/lng pair sits within the configured Cape Town bounds. */
    function withinCapeTown(lat, lng) {
      return lat >= capeTownBounds.south && lat <= capeTownBounds.north &&
             lng >= capeTownBounds.west && lng <= capeTownBounds.east;
    }

    /** Wires Google Places autocomplete to an input and stores the selection. */
    function attachAutocomplete(inputId, key) {
      const input = document.getElementById(inputId);
      const options = {
        bounds: new google.maps.LatLngBounds(
          new google.maps.LatLng(capeTownBounds.south, capeTownBounds.west),
          new google.maps.LatLng(capeTownBounds.north, capeTownBounds.east)
        ),
        strictBounds: true,
        componentRestrictions: { country: "ZA" },
        fields: ["geometry", "name", "formatted_address"]
      };

      const autocomplete = new google.maps.places.Autocomplete(input, options);

      input.addEventListener("input", () => resetStoredPlace(key));

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) {
          resetStoredPlace(key);
          return;
        }

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        if (!withinCapeTown(lat, lng)) {
          alert("Please select a location within the City of Cape Town.");
          input.value = "";
          resetStoredPlace(key);
          return;
        }

        const name = place.name || place.formatted_address || input.value;
        storedPlaces[key] = { name, lat, lng };
        document.getElementById(`${key}-lat`).value = lat;
        document.getElementById(`${key}-lng`).value = lng;
        document.getElementById(`${key}-name`).value = name;
        input.value = name;
      });
    }

    /** Prefills the date/time inputs with the current rounded departure time. */
    function setDefaultDateTime() {
      const dateEl = document.getElementById("date");
      const timeEl = document.getElementById("time");
      const now = new Date();
      const rounded = new Date(now.getTime());
      const minutes = rounded.getMinutes();
      const roundedMinutes = Math.round(minutes / 5) * 5;
      rounded.setMinutes(roundedMinutes, 0, 0);
      const isoDate = rounded.toISOString().split("T")[0];
      const hh = String(rounded.getHours()).padStart(2, "0");
      const mm = String(rounded.getMinutes()).padStart(2, "0");
      dateEl.value = isoDate;
      timeEl.value = `${hh}:${mm}`;
      dateEl.min = isoDate;
    }

    /** Collects which transport mode checkboxes are currently enabled. */
    function gatherModes() {
      const modes = [];
      if (document.getElementById("pref-bus").checked) modes.push("BUS");
      if (document.getElementById("pref-train").checked) modes.push("TRAIN");
      return modes;
    }

    /** Validates the form, builds the search query, and navigates to the loader page. */
    function handleSubmit(event) {
      event.preventDefault();

      const fromData = storedPlaces.from;
      const toData = storedPlaces.to;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const modes = gatherModes();
      const maxWalkRaw = document.getElementById("max-walk").value.trim();

      if (!fromData || !toData) {
        alert("Please choose both a start and destination from the suggestions within Cape Town.");
        return;
      }

      if (!modes.length) {
        alert("Keep at least one transport mode selected.");
        return;
      }

      if (!date || !time) {
        alert("Please provide a departure date and time.");
        return;
      }

      const params = new URLSearchParams({
        fromName: fromData.name,
        fromLat: fromData.lat,
        fromLng: fromData.lng,
        toName: toData.name,
        toLat: toData.lat,
        toLng: toData.lng,
        date,
        time,
        modes: modes.join(",")
      });

      if (maxWalkRaw !== "") {
        const numericWalk = Number(maxWalkRaw);
        if (!Number.isFinite(numericWalk) || numericWalk < 0) {
          alert("Maximum walking distance must be a non-negative number.");
          return;
        }
        params.set("maxWalkMeters", String(Math.round(numericWalk)));
      }

      window.location.href = `search.html?${params.toString()}`;
    }

    /** Bootstraps the home page once the Google Maps script callback fires. */
    function initPage() {
      setDefaultDateTime();
      attachAutocomplete("from", "from");
      attachAutocomplete("to", "to");
      document.getElementById("journey-form").addEventListener("submit", handleSubmit);
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnLAIO_seP2Xbvet0EhibJFjWbg7wR2Io&libraries=places&callback=initPage" async defer></script>
</body>
</html>
